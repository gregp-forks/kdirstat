/*
 *   File name:	kdirstatapp.cpp
 *   Summary:	The KDirStat application - menu bar, tool bar, ...
 *   License:	GPL - See file COPYING for details.
 *
 *   Author:	Stefan Hundhammer <sh@suse.de>
 *		Parts auto-generated by KDevelop - sorry for the mess
 *
 *   Updated:	2001-06-14
 *
 *   $Id: kdirstatapp.cpp,v 1.1 2001/06/29 16:37:49 hundhammer Exp $
 *
 */


#include <kapp.h>
#include <kiconloader.h>
#include <kmessagebox.h>
#include <kfiledialog.h>
#include <kmenubar.h>
#include <klocale.h>
#include <kconfig.h>
#include <kstdaction.h>
#include <kdebug.h>

#include "kdirstatapp.h"
#include "kpacman.h"

#define ID_STATUS_MSG 1


KDirStatApp::KDirStatApp( QWidget* , const char* name )
    : KMainWindow( 0, name )
{
    config=kapp->config();
    _view = new KDirStat::KDirTreeView( this );
    setCentralWidget( _view );
    connect( _view, SIGNAL( progressInfo(  const QString & ) ),
	     this,  SLOT  ( slotStatusMsg( const QString & ) ) );

    // call inits to invoke all other construction parts
    initStatusBar();
    initActions();

    _pacMan = new KPacMan( toolBar() );
    _pacMan->setInterval( 75 );	// millisec
    int id = 42;
    toolBar()->insertWidget( id, 350, _pacMan );
    toolBar()->setItemAutoSized( id, false );
    toolBar()->insertWidget( ++id, 1, new QWidget( toolBar() ) );

    connect( _view, SIGNAL( startingReading()	), _pacMan, SLOT( start() ) );
    connect( _view, SIGNAL( finished() 		), _pacMan, SLOT( stop () ) );
    
    readOptions();

    // disable actions at startup
    editCopy->setEnabled( false );

}

KDirStatApp::~KDirStatApp()
{

}


void
KDirStatApp::initActions()
{
    fileNewWindow = new KAction( i18n( "New &Window" ), 0, 0, this,
				 SLOT( slotFileNewWindow() ),
				 actionCollection(),"file_new_window" );
    
    fileOpenDir		= KStdAction::open		( this, SLOT( slotFileOpenDir()		), actionCollection() );
    fileOpenRecent	= KStdAction::openRecent	( this, SLOT( slotFileOpenRecent( const KURL& ) ), actionCollection() );
    fileCloseDir	= KStdAction::close		( this, SLOT( slotFileCloseDir()	), actionCollection() );
    fileQuit		= KStdAction::quit		( kapp, SLOT( quit()  			), actionCollection() );
    editCopy		= KStdAction::copy		( this, SLOT( slotEditCopy() 		), actionCollection() );
    viewToolBar		= KStdAction::showToolbar	( this, SLOT( slotToggleToolBar()	), actionCollection() );
    viewStatusBar	= KStdAction::showStatusbar	( this, SLOT( slotToggleStatusBar() 	), actionCollection() );

    fileNewWindow->setStatusText	( i18n( "Opens a new application window" 	) );
    fileOpenDir->setStatusText		( i18n( "Opens an existing document" 		) );
    fileOpenRecent->setStatusText	( i18n( "Opens a recently used file" 		) );
    fileCloseDir->setStatusText		( i18n( "Closes the current document" 		) );
    fileQuit->setStatusText		( i18n( "Quits the application" 		) );
    editCopy->setStatusText		( i18n( "Copies the selected section to the clipboard" ) );
    viewToolBar->setStatusText		( i18n( "Enables/disables the toolbar" 		) );
    viewStatusBar->setStatusText	( i18n( "Enables/disables the statusbar" 	) );

    // use the absolute path to your kdirstatui.rc file for testing purpose in createGUI();
    createGUI();
}


void
KDirStatApp::initStatusBar()
{
    // STATUSBAR
    // TODO: add your own items you need for displaying current application status.
    statusBar()->insertItem( i18n( "Ready." ), ID_STATUS_MSG );
}


void
KDirStatApp::openURL( const KURL& url )
{
    slotStatusMsg( i18n( "Opening file..." ) );

    _view->openURL( url );
    fileOpenRecent->addURL( url );
    
    slotStatusMsg( i18n( "Ready." ) );
}


void
KDirStatApp::saveOptions()
{	
    config->setGroup( "General Options" );
    config->writeEntry( "Geometry", 		size() );
    config->writeEntry( "Show Toolbar", 	viewToolBar->isChecked() );
    config->writeEntry( "Show Statusbar",	viewStatusBar->isChecked() );
    config->writeEntry( "ToolBarPos", 		(int ) toolBar( "mainToolBar" )->barPos() );
    fileOpenRecent->saveEntries(  config,"Recent Files" );
}


void KDirStatApp::readOptions()
{
	
    config->setGroup( "General Options" );

    // bar status settings
    bool showToolbar = config->readBoolEntry( "Show Toolbar", true );
    viewToolBar->setChecked( showToolbar );
    slotToggleToolBar();

    bool showStatusbar = config->readBoolEntry( "Show Statusbar", true );
    viewStatusBar->setChecked( showStatusbar );
    slotToggleStatusBar();


    // bar position settings
    KToolBar::BarPosition toolBarPos;
    toolBarPos=( KToolBar::BarPosition ) config->readNumEntry( "ToolBarPos", KToolBar::Top );
    toolBar( "mainToolBar" )->setBarPos( toolBarPos );
	
    // initialize the recent file list
    fileOpenRecent->loadEntries( config,"Recent Files" );

    QSize size=config->readSizeEntry( "Geometry" );
    
    if( ! size.isEmpty() )
    {
	resize( size );
    }
}


void
KDirStatApp::saveProperties( KConfig *config )
{
    (void) config;
    // TODO
}


void
KDirStatApp::readProperties( KConfig *config )
{
    (void) config;
    // TODO
}		


bool
KDirStatApp::queryClose()
{
    return true;
}

bool
KDirStatApp::queryExit()
{
    saveOptions();
    return true;
}


//============================================================================
//				     Slots
//============================================================================


void
KDirStatApp::slotFileNewWindow()
{
    slotStatusMsg( i18n( "Opening a new application window..." ) );
	
    KDirStatApp *new_window= new KDirStatApp();
    new_window->show();

    slotStatusMsg( i18n( "Ready." ) );
}


void
KDirStatApp::slotFileNew()
{
    // TODO
}


void
KDirStatApp::slotFileOpenDir()
{
    slotStatusMsg( i18n( "Opening directory..." ) );

    {	
	KURL url=KFileDialog::getExistingDirectory( QString::null, this, i18n( "Open Directory..." ) );
	
	if( !url.isEmpty() )
	{
	    _view->openURL( url );
	    setCaption( url.fileName(), false );
	    fileOpenRecent->addURL( url );
	}
    }
    slotStatusMsg( i18n( "Ready." ) );
}


void
KDirStatApp::slotFileOpenRecent( const KURL& url )
{
    slotStatusMsg( i18n( "Opening directory..." ) );

    (void) url;

    if( !url.isEmpty() )
    {
	_view->openURL( url );
	setCaption( url.fileName(), false );
    }

    slotStatusMsg( i18n( "Ready." ) );
}


void
KDirStatApp::slotFileCloseDir()
{
    slotStatusMsg( i18n( "Closing directory..." ) );
	
    close();

    slotStatusMsg( i18n( "Ready." ) );
}


void
KDirStatApp::slotEditCopy()
{
    slotStatusMsg( i18n( "Copying selection to clipboard..." ) );

    // TODO
    
    slotStatusMsg( i18n( "Ready." ) );
}


void
KDirStatApp::slotToggleToolBar()
{
    slotStatusMsg( i18n( "Toggling toolbar..." ) );

    // turn Toolbar on or off
    if( !viewToolBar->isChecked() )
    {
	toolBar( "mainToolBar" )->hide();
    }
    else
    {
	toolBar( "mainToolBar" )->show();
    }		

    slotStatusMsg( i18n( "Ready." ) );
}


void
KDirStatApp::slotToggleStatusBar()
{
    slotStatusMsg( i18n( "Toggle the statusbar..." ) );

    //turn Statusbar on or off
    if( !viewStatusBar->isChecked() )
    {
	statusBar()->hide();
    }
    else
    {
	statusBar()->show();
    }

    slotStatusMsg( i18n( "Ready." ) );
}


void
KDirStatApp::slotStatusMsg( const QString &text )
{
    // change status message permanently
    statusBar()->clear();
    statusBar()->changeItem( text, ID_STATUS_MSG );
}



// EOF
